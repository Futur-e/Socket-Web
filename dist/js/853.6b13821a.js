"use strict";(self["webpackChunksocket_chat_vue3"]=self["webpackChunksocket_chat_vue3"]||[]).push([[853],{5771:function(e,t,n){n.d(t,{Z:function(){return a}});var s=n(3396);function a(e){e.forEach(((e,t,n)=>{n[t]["token"]=PubSub.subscribe(e.msgName,e.callback)})),(0,s.Jd)((()=>{e.forEach((e=>{PubSub.unsubscribe(e.token)}))}))}},918:function(e,t,n){n.d(t,{Z:function(){return c}});var s=n(7627),a=n(7458),o=n(3396);const i={iceServers:[{urls:"stun:stun.xten.com"},{urls:"stun:stun.voipbuster.com"}]};function c({mode:e,type:t}){let n,c,l,r,d;const u=e=>{e.candidate&&s.Z.state.socket?.emit("webRTC",{type:"candidate",data:e.candidate,receiverId:s.Z.state.currentSession?.receiverId})},p=e=>{(0,o.Y3)((()=>{n=document.querySelector("#remote-video"),n.srcObject!==e.streams[0]&&(n.srcObject=e.streams[0],r=e.streams[0])}))},m=()=>{"disconnected"===I.iceConnectionState&&(f(),a.ZP.info("对方已挂断通话!"))},g=async()=>{try{l=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(e){a.ZP.error("获取媒体流失败, 请检查摄像头和麦克风权限哦!"),f()}(0,o.Y3)((()=>{c=document.querySelector("#local-video"),c.srcObject=l})),l.getTracks().forEach((e=>{I.addTrack(e,l)}))},f=()=>{"new"===I.iceConnectionState&&s.Z.state.socket?.emit("webRTC",{type:"videoReq",data:"cancel",senderId:s.Z.state.userInfo?.id,receiverId:s.Z.state.currentSession?.receiverId}),l?.getTracks().forEach((e=>e.stop())),r?.getTracks().forEach((e=>e.stop())),t=t.filter((e=>"videoCall"!==e)),t.length||I.close(),s.Z.commit("setChatStatus",{type:"videoCall",status:!1}),s.Z.commit("setPC",null)},h=async()=>{const e=await I.createAnswer();await I.setLocalDescription(e),s.Z.state.socket?.emit("webRTC",{type:"answer",data:e,senderId:s.Z.state.userInfo?.id,receiverId:s.Z.state.currentSession?.receiverId})},v=async()=>{const e=await I.createOffer();await I.setLocalDescription(e),s.Z.state.socket?.emit("webRTC",{type:"offer",data:e,senderId:s.Z.state.userInfo?.id,receiverId:s.Z.state.currentSession?.receiverId})},w=()=>{d=I.createDataChannel("privateChat"),d.onopen=e=>{d.send("hi there!")},d.onmessage=e=>{}},b=e=>{d=e.channel,d.onopen=e=>{d.send("hi back")},d.onmessage=e=>{}},k=()=>{d.close(),t=t.filter((e=>"privateChat"!==e)),t.length||I.close()},y=()=>{I.ontrack=p,g().then((()=>{"receiver"===e&&h()})),I.createOfferFunc=v,I.hangup=f},_=()=>{I.ondatachannel=b,I.createDataChannelFunc=w,I.closedown=k},I=new RTCPeerConnection(i);s.Z.commit("setPC",I),s.Z.commit("setChatStatus",{type:"videoCall",status:!0}),I.onicecandidate=u,I.oniceconnectionstatechange=m,-1!==t.indexOf("videoCall")&&y(),-1!==t.indexOf("privateChat")&&_()}},7081:function(e,t,n){n.d(t,{Z:function(){return d}});var s=n(3396),a={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"defs",attrs:{},children:[{tag:"style",attrs:{}}]},{tag:"path",attrs:{d:"M482 152h60q8 0 8 8v704q0 8-8 8h-60q-8 0-8-8V160q0-8 8-8z"}},{tag:"path",attrs:{d:"M176 474h672q8 0 8 8v60q0 8-8 8H176q-8 0-8-8v-60q0-8 8-8z"}}]},name:"plus",theme:"outlined"},o=a,i=n(9388);function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?Object(arguments[t]):{},s=Object.keys(n);"function"===typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),s.forEach((function(t){l(e,t,n[t])}))}return e}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var r=function(e,t){var n=c({},e,t.attrs);return(0,s.Wm)(i.Z,c({},n,{icon:o}),null)};r.displayName="PlusOutlined",r.inheritAttrs=!1;var d=r},1492:function(e,t,n){n.r(t),n.d(t,{default:function(){return In}});var s=n(3396);const a={class:"chat"};function o(e,t,n,o,i,c){const l=(0,s.up)("session-list"),r=(0,s.up)("chat-window");return(0,s.wg)(),(0,s.iD)("div",a,[(0,s.Wm)(l),(0,s.Wm)(r,{class:"chat-window"})])}const i={key:0,class:"chat-window"},c={class:"chat-area"},l={key:0},r={key:1},d={key:1,class:"logo-page"},u=["src"];function p(e,t,a,o,p,m){const g=(0,s.up)("chat-top-bar"),f=(0,s.up)("chat-dialog"),h=(0,s.up)("input-box"),v=(0,s.up)("noti-dialog"),w=(0,s.up)("video-window");return e.store.state.currentSession&&e.store.state.currentSession.sessionId?((0,s.wg)(),(0,s.iD)("div",i,[(0,s._)("div",c,[(0,s.Wm)(g),2!==e.store.state.currentSession.type?((0,s.wg)(),(0,s.iD)("div",l,[(0,s.Wm)(f),(0,s.Wm)(h)])):((0,s.wg)(),(0,s.iD)("div",r,[(0,s.Wm)(v)]))]),(0,s.Wm)(w,{class:"video-area"})])):((0,s.wg)(),(0,s.iD)("div",d,[(0,s._)("img",{src:n(5522),alt:""},null,8,u)]))}var m=n(65),g=n(9242);function f(e,t,n,a,o,i){const c=(0,s.up)("loading"),l=(0,s.up)("scroll-box");return(0,s.wg)(),(0,s.iD)("div",{class:"chat-dialog",onDrop:t[1]||(t[1]=(0,g.iM)((t=>e.message.info("拖动到输入框可以直接发送文件哦")),["prevent"])),onDragover:t[2]||(t[2]=(0,g.iM)((()=>{}),["prevent"]))},[(0,s.Wm)(l,{class:"scroll-box",listenHeight:"",ref:"scrollBox",topDisabled:e.topDisabled,onTouchTop:t[0]||(t[0]=t=>e.getChatList(e.chatList[0].updatedAt))},{default:(0,s.w5)((()=>[!e.topDisabled&&e.chatList.length>=30?((0,s.wg)(),(0,s.j4)(c,{key:0})):(0,s.kq)("",!0),((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)(e.chatList,(e=>((0,s.wg)(),(0,s.j4)((0,s.LL)(e.component),{key:e.updatedAt,chat:e,content:e.content},null,8,["chat","content"])))),128))])),_:1},8,["topDisabled"])],32)}var h=n(3512),v=n(6265),w=n.n(v);function b(e,t){return h.Z.get("/chats/get_chat_list",{params:e,cancelToken:new(w().CancelToken)((function(e){t.cancelChatListFunc=e}))})}var k=n(7139);const y=e=>((0,s.dD)("data-v-25e67d8c"),e=e(),(0,s.Cn)(),e),_={class:"user-item"},I={class:"item-left-container"},D={class:"status"},C={class:"item-left"},Z={key:0,class:"message-container"},L=["innerHTML"],T=["src"],S={key:3,class:"message-container message"},A=y((()=>(0,s._)("i",{class:"iconfont icon-shipin"},null,-1))),F=(0,s.Uk)("我发起了一个视频通话 "),x=[A,F],j={class:"avatar"},M=["src"];function H(e,t,n,a,o,i){const c=(0,s.up)("loading"),l=(0,s.up)("download-card");return(0,s.wg)(),(0,s.iD)("div",_,[(0,s._)("div",I,[(0,s._)("div",D,["loading"==e.chat.status?((0,s.wg)(),(0,s.j4)(c,{key:0,scale:"0.5"})):"fail"==e.chat.status?((0,s.wg)(),(0,s.iD)("i",{key:1,class:"iconfont icon-shuaxin",title:"点击重发",onClick:t[0]||(t[0]=(...t)=>e.resend&&e.resend(...t))})):(0,s.kq)("",!0)]),(0,s._)("div",C,[0==e.chat.type?((0,s.wg)(),(0,s.iD)("div",Z,[(0,s._)("pre",{class:"message",innerHTML:e.content},null,8,L)])):1==e.chat.type||3==e.chat.type?((0,s.wg)(),(0,s.iD)("div",{key:1,class:"image",onContextmenu:t[3]||(t[3]=(0,g.iM)((t=>e.rightClickPic(t,e.chat)),["right","prevent"])),style:(0,k.j5)(e.imgStyle)},[(0,s._)("img",{src:e.chat.content,alt:"",onDragstart:t[1]||(t[1]=(0,g.iM)((()=>{}),["prevent"])),onClick:t[2]||(t[2]=(0,g.iM)(((...t)=>e.checkImg&&e.checkImg(...t)),["stop"]))},null,40,T)],36)):2==e.chat.type?((0,s.wg)(),(0,s.j4)(l,{key:2,file:e.chat.content,fileInfo:e.fileInfo},null,8,["file","fileInfo"])):(0,s.kq)("",!0),5==e.chat.type?((0,s.wg)(),(0,s.iD)("div",S,x)):(0,s.kq)("",!0)])]),(0,s._)("div",j,[(0,s._)("img",{src:e.store.state.userInfo.avatar,alt:""},null,8,M)])])}var O=n(3513);const P=["title"],E={class:"file-info"},N={class:"file-name"},q={class:"file-size"},B={class:"file-cover"},R=["src"],U={key:0,class:"progress-bar"};function z(e,t,a,o,i,c){return(0,s.wg)(),(0,s.iD)("div",{class:"download-card",onClick:t[0]||(t[0]=(...t)=>e.download&&e.download(...t)),title:e.fileInfo.fileName},[(0,s._)("div",E,[(0,s._)("div",N,(0,k.zw)(e.fileInfo.fileName),1),(0,s._)("div",q,(0,k.zw)(e.sizeShow),1)]),(0,s._)("div",B,[(0,s._)("img",{src:n(9295),alt:""},null,8,R)]),e.downing?((0,s.wg)(),(0,s.iD)("div",U,[(0,s._)("div",{class:"done-part",style:(0,k.j5)(`width:${e.progress}%;`)},null,4)])):(0,s.kq)("",!0)],8,P)}var Y=n(4870),$=n(7458),W=(0,s.aZ)({name:"download-card",props:{fileInfo:{type:Object,default:()=>({fileName:"",size:0})},file:String},setup(e){const t=(0,Y.qj)({progress:0,downing:!1}),n={sizeShow:(0,s.Fl)((()=>{let t=e.fileInfo?.size;return t<1024?t+"B":t<1048576?(t/1024).toFixed(2)+"K":(t/1024/1024).toFixed(2)+"M"}))};let a=null;const o=()=>{if(t.downing&&a)t.downing=!1,$.ZP.info("取消下载"),a("cancel download");else if(!t.downing){t.downing=!0,$.ZP.info("开始下载, 再次点击可取消下载");let s=/^blob/.test(e.file);if(s)n(e.file);else{let s=e.file.replace({NODE_ENV:"production",BASE_URL:"/"}.VUE_APP_DOWNLOAD,"/download");w().get(s,{responseType:"blob",onDownloadProgress:e=>{t.progress=e.loaded/e.total*100},cancelToken:new(w().CancelToken)((e=>{a=e}))}).then((e=>{let t=e.data,s=URL.createObjectURL(t);n(s)})).catch((e=>{"cancel download"!=e.message&&(t.downing=!1,$.ZP.error("下载失败!"))}))}}function n(n){let s=document.createElement("a");s.href=n,s.download=e.fileInfo?.fileName,s.click(),$.ZP.success("下载成功"),t.downing=!1,URL.revokeObjectURL(n)}};return{...(0,Y.BK)(t),...n,download:o}}}),K=n(89);const J=(0,K.Z)(W,[["render",z],["__scopeId","data-v-3d860b10"]]);var V=J,Q=n(1018),G=n(3017),X=n.n(G),ee=(0,s.aZ)({name:"user-item",components:{DownloadCard:V,Loading:Q.Z},props:{chat:{type:Object,default:null}},setup(e){const t=(0,m.oR)(),n={content:(0,s.Fl)((()=>(0,O.tZ)(e.chat.content))),imgStyle:(0,s.Fl)((()=>{if(/^blob:/.test(e.chat.content))return"";let t=/\??size=([0-9]{1,3}x[0-9]{1,3})&?/,n=e.chat.content.match(t)[1].split("x");return`width:${n[0]}px;height:${n[1]}px;`})),fileInfo:(0,s.Fl)((()=>/^blob:/.test(e.chat.content)?e.chat.fileInfo:JSON.parse(e.chat.others)))};let a=null;(0,s.bv)((()=>{c()})),(0,s.Jd)((()=>{a&&clearTimeout(a)}));const o=()=>{let n={content:e.chat.file,receiverId:e.chat.receiverId,uuid:e.chat.uuid,type:e.chat.type,sessionId:e.chat.sessionId,fileInfo:e.chat.fileInfo};t.state.socket?.emit("chat",n);let s=e.chat;s.status="loading",c()},i=(e,t)=>{"fail"!==t.status&&"loading"!==t.status?X().publish("rightMenu",{position:{x:e.x,y:e.y},menuList:[{content:"收藏至自定义表情",callback:()=>{X().publish("addEmoticon",t.content)}}]}):$.ZP.info(`图片当前处于${t.status}阶段, 无法操作`)},c=()=>{"loading"==e.chat.status&&(a=setTimeout((()=>{if("loading"==e.chat.status){let t=e.chat;t.status="fail"}a=null}),1e4))},l=e=>{X().publish("viewPicture",e.target)};return{checkImg:l,rightClickPic:i,resend:o,...n,store:t}}});const te=(0,K.Z)(ee,[["render",H],["__scopeId","data-v-25e67d8c"]]);var ne=te;const se=e=>((0,s.dD)("data-v-7dd0d00a"),e=e(),(0,s.Cn)(),e),ae={class:"talker-item"},oe={class:"avatar"},ie=["src"],ce={class:"item-right"},le={key:0,class:"item-right-top"},re={class:"user-name"},de={class:"time"},ue={key:1,class:"message-container"},pe=["innerHTML"],me=["src"],ge={key:4,class:"message-container message"},fe=se((()=>(0,s._)("i",{class:"iconfont icon-shipin"},null,-1))),he=(0,s.Uk)("对方发起了一个视频邀请 "),ve=[fe,he];function we(e,t,n,a,o,i){const c=(0,s.up)("download-card");return(0,s.wg)(),(0,s.iD)("div",ae,[(0,s._)("div",oe,[(0,s._)("img",{src:e.userInfo?.avatar,alt:""},null,8,ie)]),(0,s._)("div",ce,[1===e.chat?.sort?((0,s.wg)(),(0,s.iD)("div",le,[(0,s._)("span",re,(0,k.zw)(e.userInfo?.userName),1),(0,s._)("span",de,(0,k.zw)(e.chat?.updatedAt),1)])):(0,s.kq)("",!0),0==e.chat?.type?((0,s.wg)(),(0,s.iD)("div",ue,[(0,s._)("pre",{class:"message",innerHTML:e.content},null,8,pe)])):1==e.chat.type||3==e.chat.type?((0,s.wg)(),(0,s.iD)("div",{key:2,class:"image",onContextmenu:t[2]||(t[2]=(0,g.iM)((t=>e.rightClickPic(t,e.chat.content)),["right","prevent"])),style:(0,k.j5)(e.imgStyle)},[(0,s._)("img",{src:e.chat.content,alt:"",onDragstart:t[0]||(t[0]=(0,g.iM)((()=>{}),["prevent"])),onClick:t[1]||(t[1]=(0,g.iM)(((...t)=>e.checkImg&&e.checkImg(...t)),["stop"]))},null,40,me)],36)):2==e.chat.type?((0,s.wg)(),(0,s.j4)(c,{key:3,file:e.chat.content,fileInfo:e.fileInfo},null,8,["file","fileInfo"])):(0,s.kq)("",!0),5==e.chat.type?((0,s.wg)(),(0,s.iD)("div",ge,ve)):(0,s.kq)("",!0)])])}var be=(0,s.aZ)({name:"talker-item",components:{DownloadCard:V},props:{chat:{type:Object,default:()=>null}},setup(e){const t=(0,m.oR)(),n=(0,Y.qj)({userInfo:null}),a={content:(0,s.Fl)((()=>(0,O.tZ)(e.chat.content))),imgStyle:(0,s.Fl)((()=>{if(/^blob:/.test(e.chat.content))return"";let t=/\??size=([0-9]{1,3}x[0-9]{1,3})&?/,n=e.chat.content.match(t)[1].split("x");return`width:${n[0]}px;height:${n[1]}px;`})),fileInfo:(0,s.Fl)((()=>/^blob:/.test(e.chat.content)?e.chat.fileInfo:JSON.parse(e.chat.others)))};(0,s.bv)((()=>{0===t.state.currentSession.type&&(n.userInfo=t.state.currentSession.user)}));const o=(e,t)=>{X().publish("rightMenu",{position:{x:e.x,y:e.y},menuList:[{content:"收藏至自定义表情",callback:()=>{X().publish("addEmoticon",t)}}]})},i=e=>{X().publish("viewPicture",e.target)};return{...(0,Y.BK)(n),...a,rightClickPic:o,checkImg:i}}});const ke=(0,K.Z)(be,[["render",we],["__scopeId","data-v-7dd0d00a"]]);var ye=ke;const _e={class:"time-tag"};function Ie(e,t,n,a,o,i){return(0,s.wg)(),(0,s.iD)("div",_e,[(0,s._)("span",null,(0,k.zw)(e.content),1)])}var De=(0,s.aZ)({props:{content:String}});const Ce=(0,K.Z)(De,[["render",Ie],["__scopeId","data-v-c83a49ee"]]);var Ze=Ce,Le=n(6745),Te=n(6797),Se=n.n(Te),Ae=n(5771),Fe=(0,s.aZ)({components:{userItem:ne,TalkerItem:ye,ScrollBox:Le.Z,Loading:Q.Z,NotificationTag:Ze},name:"chat-dialog",props:{sessionId:String},setup(){const e=(0,m.oR)(),{proxy:t}=(0,s.FN)(),n=(0,Y.qj)({chatList:[],topDisabled:!1,cancelChatListFunc:null});let a=null,o=null;(0,s.wF)((()=>{o=g(),(0,Ae.Z)([{msgName:"sendMsg",callback:c},{msgName:"chat",callback:l},{msgName:"sendMsgSuccess",callback:r},{msgName:"sendMsgFail",callback:d}])})),(0,s.bv)((()=>{a=t&&t.$refs.scrollBox,i()})),(0,s.Jd)((()=>{n.cancelChatListFunc&&n.cancelChatListFunc()}));const i=async t=>{n.topDisabled=!0;let s=await b({sessionId:e.state.currentSession.sessionId,lastTime:t},n);if(s){let e=p(s.list);t?a&&a.keepHeight((()=>{n.chatList.unshift(...e)})):(n.chatList.unshift(...e),u("instant")),n.topDisabled=e.length<30,n.cancelChatListFunc=null}},c=(e,t)=>{let s=n.chatList,a=o&&o(t,s[s.length-1]);a&&s.push(a),t.component="user-item",s.push(t);let i=setTimeout((()=>{u(),clearTimeout(i),i=-1}),50)},l=(t,s)=>{let i=n.chatList;if(s.sessionId===e.state.currentSession.sessionId){if(4==s.type)s.component="notification-tag";else{let t=o&&o(s,i[i.length-1]);t&&i.push(t),s.component=s.talkerId==e.state.currentSession.receiverId?"talker-item":"user-item"}i.push(s),a&&a.getIsBottom(100)&&u()}},r=(e,t)=>{let s=n.chatList;for(let n=s.length-1;n>=0;n--){let e=s[n];if(e.uuid===t.uuid){e.updatedAt=t.updatedAt,e.status="success",1===e.type&&(e.content=t.content);break}}},d=(t,s)=>{if(e.state.currentSession.sessionId!==s.sessionId)return;let a=n.chatList;for(let e=a.length-1;e>=0;e--){let t=a[e];if(t.uuid===s.uuid){t.status="fail";break}}},u=e=>{(0,s.Y3)((()=>{t&&!t.$refs.scrollBox||a&&a.scrollToFunc(e)}))},p=t=>{let n=[],s=e.state.userInfo.id;return t.forEach(((e,t,a)=>{if(4==e.type)switch(e["component"]="notification-tag",e.content){case"deleteFriend":e.content=(e.senderId==s?"您已与对方":"对方已与您")+"解除好友关系";break;default:break}else e.senderId==s?e["component"]="user-item":e["component"]="talker-item";n.unshift(e);let i=t<a.length-1&&o&&o(e,a[t+1]);i&&n.unshift(i)})),n},g=()=>{let e=Se()().startOf("day").valueOf(),t=Se()().week(Se()().week()-1).startOf("week").valueOf()+864e5;return function(n,s){let a=parseInt(n.updatedAt),o=parseInt(s.updatedAt);if(a-o>3e5){let n=null;return n=a>e?Se()(a).format("HH:mm"):a>t?Se()(a).locale("zh-cn").format("dddd HH:mm"):Se()(a).format("YYYY年MM月DD日 HH:mm"),{content:n,component:"notification-tag",updatedAt:a.toString()}}}};return(0,s.YP)((()=>e.state.currentSession),(e=>{n.chatList=[],n.cancelChatListFunc&&n.cancelChatListFunc("cancelChatListFunc"),-1!==e.receiverId&&i()})),{...(0,Y.BK)(n),getChatList:i,message:$.ZP}}});const xe=(0,K.Z)(Fe,[["render",f],["__scopeId","data-v-1768ba33"]]);var je=xe;const Me={class:"chat-top-bar"},He={class:"bar-left"};function Oe(e,t,n,a,o,i){return(0,s.wg)(),(0,s.iD)("div",Me,[(0,s._)("div",He,(0,k.zw)(a.store.state.currentSession.sessionName),1)])}var Pe={name:"chat-top-bar",setup(){const e=(0,m.oR)();return{store:e}}};const Ee=(0,K.Z)(Pe,[["render",Oe],["__scopeId","data-v-eed66ecc"]]);var Ne=Ee;const qe=e=>((0,s.dD)("data-v-1df7ac67"),e=e(),(0,s.Cn)(),e),Be={class:"function-bar"},Re={class:"bar-left"},Ue=qe((()=>(0,s._)("i",{class:"iconfont icon-biaoqing-xue"},null,-1))),ze=qe((()=>(0,s._)("i",{class:"iconfont icon-wenjianjiawenjianguanli"},null,-1))),Ye={class:"bar-right"},$e=qe((()=>(0,s._)("span",{style:{color:"white"}},"点对点私密聊天, 聊天信息将不会经过服务器, 且不会被保存",-1))),We={class:"bottom-bar"};function Ke(e,t,n,a,o,i){const c=(0,s.up)("emoji-dialog"),l=(0,s.up)("upload-cmp"),r=(0,s.up)("a-tooltip"),d=(0,s.up)("chat-input");return(0,s.wg)(),(0,s.iD)("div",{class:"input-box",tabindex:"1",onDrop:t[3]||(t[3]=(0,g.iM)(((...e)=>a.dropFile&&a.dropFile(...e)),["prevent"])),onDragover:t[4]||(t[4]=(0,g.iM)((()=>{}),["prevent"]))},[(0,s._)("div",Be,[(0,s._)("div",Re,[(0,s.Wm)(c,{onSelectEmoji:a.selectEmoji},{default:(0,s.w5)((()=>[Ue])),_:1},8,["onSelectEmoji"]),(0,s.Wm)(l,{onUploadFile:a.uploadFile},{default:(0,s.w5)((()=>[ze])),_:1},8,["onUploadFile"])]),(0,s._)("div",Ye,[(0,s.Wm)(r,{placement:"topLeft"},{title:(0,s.w5)((()=>[$e])),default:(0,s.w5)((()=>[(0,s._)("i",{class:"iconfont icon-jiami",onClick:t[0]||(t[0]=e=>a.message.info("私密聊天正在火速开发中哦!"))})])),_:1}),(0,s._)("i",{class:"iconfont icon-shipin",onClick:t[1]||(t[1]=(...e)=>a.videoHandler&&a.videoHandler(...e))})])]),(0,s.Wm)(d,{class:"chat-input-cmp",ref:"chatInput",onSendMsg:a.sendMsg,onUploadFile:a.uploadFile},null,8,["onSendMsg","onUploadFile"]),(0,s._)("div",We,[(0,s._)("div",{class:"send",onClick:t[2]||(t[2]=e=>a.proxy.$refs.chatInput.sendMsg())},"发送")])],32)}const Je={class:"input-container"};function Ve(e,t,n,a,o,i){return(0,s.wg)(),(0,s.iD)("div",Je,[(0,s._)("div",{class:"chat-input",contenteditable:"",onMousedown:t[0]||(t[0]=(...t)=>e.getLastLocation&&e.getLastLocation(...t)),onKeydown:t[1]||(t[1]=(...t)=>e.keydownFunc&&e.keydownFunc(...t)),onKeyup:t[2]||(t[2]=(...t)=>e.keyupFunc&&e.keyupFunc(...t)),onPaste:t[3]||(t[3]=(0,g.iM)(((...t)=>e.pasteFunc&&e.pasteFunc(...t)),["prevent"])),onInput:t[4]||(t[4]=(...t)=>e.inputFunc&&e.inputFunc(...t))},null,32)])}var Qe=(0,s.aZ)({name:"chat-input",setup(e,{emit:t}){const{proxy:a}=(0,s.FN)(),o=(0,Y.qj)({content:""});let i,c,l=null;(0,s.bv)((()=>{i=a&&a.$el.querySelector(".chat-input"),c=getSelection()}));const r=e=>{l||f();let t=document.createElement("img");t.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAApJREFUCNdjYAAAAAIAAeIhvDMAAAAASUVORK5CYII=",t.alt=`[emoji-${e}]`,t.draggable=!1,t.style=`\n        height: 22px;\n        width: 24px;\n        background: url(${n(778)});\n        background-repeat: no-repeat;\n        background-size: 24px;\n        margin:0 1px;\n        background-position:0 ${-24*e}px;\n        vertical-align: text-bottom;\n      `,h(t)},d=()=>{let e=i.innerHTML.trim();""!==e?e.length>5e3?$.ZP.warn("发送内容长度不能超过5000哦"):(e=v(e),e=e.replace(/</gi,"&lt;").replace(/>/gi,"&gt;"),t("sendMsg",e),i.innerHTML=""):$.ZP.warn("发送内容不能为空哦")},u=e=>{let n=e.clipboardData?.files[0];if(n)return void t("uploadFile",n);let s=e.clipboardData?.getData("text");s=s?.replace(/</gi,"&lt;").replace(/>/gi,"&gt;"),s=s&&(0,O.tZ)(s),document.execCommand("insertHTML",!1,s),p()},p=()=>{if(f(),!/\n$/.test(i.innerHTML)){let e=document.createTextNode("\n");i.appendChild(e)}},m=e=>{let t=e.keyCode;if(e.ctrlKey&&13===t){e.preventDefault();let t=document.createTextNode("\n");h(t),i.scrollTo({top:i.scrollTop+20,behavior:"smooth"})}else 13===t&&(e.preventDefault(),d())},g=e=>{let t=e.keyCode;if(t>=37&&t<=40)f();else if(8===t&&/<br>/g.test(i.innerHTML)){i.innerHTML=i.innerHTML.replace(/<br>/g,"");let e=window.getSelection();e?.selectAllChildren(i),e?.collapseToEnd()}},f=()=>{i.focus(),l=c?.getRangeAt(0),l.collapse(!1)},h=e=>{c?.removeAllRanges(),l&&c?.addRange(l),l?.deleteContents(),l?.insertNode(e),p()},v=e=>{let t=/<img.*?alt="(.*?)".*?>/g;return e.replace(t,"$1")};return{...(0,Y.BK)(o),addEmoji:r,pasteFunc:u,inputFunc:p,keydownFunc:m,keyupFunc:g,getLastLocation:f}}});const Ge=(0,K.Z)(Qe,[["render",Ve],["__scopeId","data-v-dd70b656"]]);var Xe=Ge;const et=e=>((0,s.dD)("data-v-1943fbe2"),e=e(),(0,s.Cn)(),e),tt={class:"emoji-dialog"},nt={class:"emoji-container"},st={class:"emoticon-tab"},at=["onClick"],ot={class:"emoticon-tab"},it=["onClick"],ct={class:"tab-selector"},lt=et((()=>(0,s._)("i",{class:"iconfont icon-biaoqing-xue"},null,-1))),rt=[lt],dt=et((()=>(0,s._)("i",{class:"iconfont icon-jushoucang"},null,-1))),ut=[dt];function pt(e,t,n,a,o,i){const c=(0,s.up)("loading-outlined"),l=(0,s.up)("plus-outlined"),r=(0,s.up)("a-upload"),d=(0,s.Q2)("lazyload"),u=(0,s.Q2)("clickoutside");return(0,s.wy)(((0,s.wg)(),(0,s.iD)("div",tt,[(0,s.wy)((0,s._)("div",nt,[(0,s.wy)((0,s._)("div",st,[((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)(e.emojiNum,(t=>((0,s.wg)(),(0,s.iD)("div",{class:"emoji-item",onClick:n=>e.selectEmoji(0,t),key:t,style:(0,k.j5)({"background-position":`0 ${-24*t}px`})},null,12,at)))),128))],512),[[g.F8,0===e.currentTab]]),(0,s.wy)((0,s._)("div",ot,[(0,s.Wm)(r,{name:"file","list-type":"picture-card",class:"avatar-uploader emoticon-item",data:{emoticon:!0},"show-upload-list":!1,action:"/api/files/upload_file","before-upload":e.beforeUpload,onChange:e.handleChange},{default:(0,s.w5)((()=>[(0,s._)("div",null,[e.uploadEmoLoading?((0,s.wg)(),(0,s.j4)(c,{key:0})):((0,s.wg)(),(0,s.j4)(l,{key:1}))])])),_:1},8,["before-upload","onChange"]),((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)(e.emoticonList,(n=>(0,s.wy)(((0,s.wg)(),(0,s.iD)("img",{class:"emoticon-item",key:n.id,onDragstart:t[0]||(t[0]=(0,g.iM)((()=>{}),["prevent"])),onClick:t=>e.selectEmoji(1,n.src)},null,40,it)),[[d,n.src]]))),128))],512),[[g.F8,1===e.currentTab]]),(0,s._)("div",ct,[(0,s._)("div",{class:(0,k.C_)(["tab-item",{"current-tab-item":0==e.currentTab}]),onClick:t[1]||(t[1]=t=>e.currentTab=0)},rt,2),(0,s._)("div",{class:(0,k.C_)(["tab-item",{"current-tab-item":1==e.currentTab}]),onClick:t[2]||(t[2]=t=>e.currentTab=1)},ut,2)])],512),[[g.F8,e.showDialog]]),(0,s._)("div",{class:"btnContainer",onClick:t[3]||(t[3]=t=>e.showDialog=!e.showDialog)},[(0,s.WI)(e.$slots,"default",{},void 0,!0)])])),[[u,()=>{e.showDialog=!1}]])}function mt(){return h.Z.get("/emoticons/get_emoticon_list")}function gt(e){return h.Z.get("/emoticons/add_emoticon",{params:e})}var ft=n(7081),ht=n(2510),vt=(0,s.aZ)({name:"emoji-dialog",components:{PlusOutlined:ft.Z,LoadingOutlined:ht.Z},setup(e,{emit:t}){const n=(0,Y.qj)({showDialog:!1,emojiNum:124,currentTab:0,emoticonList:[],uploadEmoLoading:!1});(0,s.wF)((()=>{(0,Ae.Z)([{msgName:"addEmoticon",callback:c}])})),(0,s.bv)((async()=>{let e=await mt();e&&(n.emoticonList=e.list)}));const a=(e,s)=>{t("selectEmoji",{type:e,item:s}),n.showDialog=!1},o=e=>{"uploading"!==e.file.status?"done"===e.file.status&&(n.emoticonList.unshift({id:e.file.response.id,src:e.file.response.src}),n.uploadEmoLoading=!1):n.uploadEmoLoading=!0},i=e=>{const t="image/jpeg"===e.type||"image/png"===e.type;t||$.ZP.error("You can only upload JPG file!");const n=e.size/1024/1024<2;return n||$.ZP.error("Image must smaller than 2MB!"),t&&n},c=async(e,t)=>{let s=await gt({src:t});s&&($.ZP.success("表情收藏成功"),n.emoticonList.unshift({src:s.src,id:s.id}))};return{...(0,Y.BK)(n),selectEmoji:a,handleChange:o,beforeUpload:i}}});const wt=(0,K.Z)(vt,[["render",pt],["__scopeId","data-v-1943fbe2"]]);var bt=wt;const kt={class:"upload-cmp"},yt={for:"uploadFile"};function _t(e,t,n,a,o,i){return(0,s.wg)(),(0,s.iD)("div",kt,[(0,s.wy)((0,s._)("input",{type:"file",id:"uploadFile",onChange:t[0]||(t[0]=(...t)=>e.uploadFile&&e.uploadFile(...t))},null,544),[[g.F8,!1]]),(0,s._)("label",yt,[(0,s.WI)(e.$slots,"default")])])}var It=(0,s.aZ)({name:"upload-cmp",setup(e,{emit:t}){const n=e=>{let n=e.target;if(null!=n){let s=n.files[0];t("uploadFile",s),e.target.value=""}};return{uploadFile:n}},methods:{}});const Dt=(0,K.Z)(It,[["render",_t]]);var Ct=Dt,Zt=n(918);const Lt=15;var Tt={components:{ChatInput:Xe,EmojiDialog:bt,UploadCmp:Ct},name:"input-box",setup(){const e=(0,m.oR)(),{proxy:t}=(0,s.FN)(),n=(t,n=0,s)=>{let a={content:t,receiverId:e.state.currentSession.receiverId,uuid:(0,O.M8)(),type:n,sessionId:e.state.currentSession.sessionId,fileInfo:s};e.state.socket?.emit("chat",a),a["senderId"]=e.state.userInfo.id,a["status"]="loading",a["updatedAt"]=(new Date).getTime(),1!=n&&2!=n||(a["content"]=window.URL.createObjectURL(t),a["file"]=t),X().publish("sendMsg",a)},a=({type:e,item:s})=>{0===e?t&&t.$refs.chatInput.addEmoji(s):1===e&&n(s.toString(),3)},o=e=>{let t=e.dataTransfer&&e.dataTransfer.files[0];t&&i(t)},i=e=>{if(e.size>2097152)return void $.ZP.warn("上传的文件不能超过 2M 哦");let t=/image\/png|image\/jpeg|image\/gif/.test(e.type)?1:2;n(e,t,{fileName:e.name,size:e.size})},c=()=>{n("[视频通话]",5),(0,Zt.Z)({mode:"sender",type:["videoCall"]}),setTimeout((()=>{"new"===e.state.pc?.iceConnectionState&&($.ZP.info("通话暂时无人接听哦!"),e.state.pc.hangup())}),1e3*Lt)};return{sendMsg:n,dropFile:o,uploadFile:i,selectEmoji:a,proxy:t,videoHandler:c,message:$.ZP}}};const St=(0,K.Z)(Tt,[["render",Ke],["__scopeId","data-v-1df7ac67"]]);var At=St;const Ft=e=>((0,s.dD)("data-v-ee9dd83a"),e=e(),(0,s.Cn)(),e),xt={class:"noti-dialog"},jt={class:""},Mt={key:0,class:"noti-container"},Ht=Ft((()=>(0,s._)("div",{class:"noti-title"},"登录操作通知",-1))),Ot={class:"noti-content"},Pt={class:"noti-detail"},Et={class:"noti-detail-item"},Nt={class:"noti-detail-item"};function qt(e,t,n,a,o,i){const c=(0,s.up)("loading"),l=(0,s.up)("scroll-box");return(0,s.wg)(),(0,s.iD)("div",xt,[(0,s.Wm)(l,{class:"scroll-box",listenHeight:"",ref:"scrollBox",bottomDisabled:!0,topDisabled:e.topDisabled,onTouchTop:e.touchTop},{default:(0,s.w5)((()=>[!e.topDisabled&&e.notiList.length>=30?((0,s.wg)(),(0,s.j4)(c,{key:0})):(0,s.kq)("",!0),((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)(e.notiList,(t=>((0,s.wg)(),(0,s.iD)("div",{class:"noti-item",key:t.createdAt},[(0,s._)("div",jt,[0===t.type?((0,s.wg)(),(0,s.iD)("div",Mt,[Ht,(0,s._)("div",Ot,(0,k.zw)(`你的账号 "${e.store.state.userInfo.userName}" 进行了登录操作`),1),(0,s._)("div",Pt,[(0,s._)("div",Et,"登录ID："+(0,k.zw)(e.store.state.userInfo.id),1),(0,s._)("div",Nt,"登录时间："+(0,k.zw)(t.createdAt&&e.handleTime(t.createdAt)),1)])])):(0,s.kq)("",!0)])])))),128))])),_:1},8,["topDisabled","onTouchTop"])])}function Bt(e){return h.Z.get("/notis/get_noti_list",{params:e})}var Rt=(0,s.aZ)({components:{ScrollBox:Le.Z,Loading:Q.Z},name:"noti-dialog",setup(){const{proxy:e}=(0,s.FN)(),t=(0,m.oR)(),n=(0,Y.qj)({notiList:[],topDisabled:!1}),a={handleTime:(0,s.Fl)((()=>e=>Se()(parseInt(e)).format("YYYY年MM月DD日 HH:mm")))};(0,s.wF)((()=>{(0,Ae.Z)([{msgName:"notice",callback:c}])})),(0,s.bv)((()=>{o()}));const o=async t=>{let s=await Bt({lastTime:t});if(s){let a=s.list.reverse();t?e&&e.$refs.scrollBox.keepHeight((()=>{n.notiList.unshift(...a)})):(n.notiList.unshift(...a),l("instant")),n.topDisabled=30!==a.length}},i=()=>{n.topDisabled=!0,o(n.notiList[0].createdAt)},c=(t,s)=>{let a=null;switch(s?.msgType){case"login":a=0;break}n.notiList.push({type:a,createdAt:s.time.toString()}),e?.$refs.scrollBox.getIsBottom(100)&&l()},l=t=>{(0,s.Y3)((()=>{e?.$refs.scrollBox&&e.$refs.scrollBox.scrollToFunc(t)}))};return{...(0,Y.BK)(n),...a,touchTop:i,store:t}}});const Ut=(0,K.Z)(Rt,[["render",qt],["__scopeId","data-v-ee9dd83a"]]);var zt=Ut;const Yt=e=>((0,s.dD)("data-v-36a3efbf"),e=e(),(0,s.Cn)(),e),$t={key:0,class:"video-area"},Wt=Yt((()=>(0,s._)("video",{id:"local-video",autoplay:"",muted:""},null,-1))),Kt=Yt((()=>(0,s._)("i",{class:"iconfont icon-guaduan"},null,-1))),Jt=[Kt];function Vt(e,t,n,a,o,i){return e.store.state.chatStatus.videoCall?((0,s.wg)(),(0,s.iD)("div",$t,[Wt,(0,s._)("video",{id:"remote-video",autoplay:"",controls:"",onClick:t[0]||(t[0]=(0,g.iM)((()=>{}),["prevent"]))}),(0,s._)("div",{class:"hangup-btn",onClick:t[1]||(t[1]=t=>e.store.state.pc.hangup())},Jt)])):(0,s.kq)("",!0)}var Qt=(0,s.aZ)({setup(){const e=(0,m.oR)();return{store:e}}});const Gt=(0,K.Z)(Qt,[["render",Vt],["__scopeId","data-v-36a3efbf"]]);var Xt=Gt,en=(0,s.aZ)({components:{InputBox:At,ChatDialog:je,ChatTopBar:Ne,NotiDialog:zt,VideoWindow:Xt},name:"chat-window",setup(){const e=(0,m.oR)();return{store:e}}});const tn=(0,K.Z)(en,[["render",p],["__scopeId","data-v-5377033d"]]);var nn=tn;const sn=e=>((0,s.dD)("data-v-5c07dbb6"),e=e(),(0,s.Cn)(),e),an={class:"session-list"},on=sn((()=>(0,s._)("div",{class:"session-top"},[(0,s._)("div",{class:"session-search"},[(0,s._)("i",{class:"iconfont icon-sousuoxiao"}),(0,s._)("input",{type:"text",placeholder:"搜索"})])],-1))),cn=["onClick"],ln={class:"cover"},rn=["src"],dn=["textContent"],un={class:"session-info"},pn={class:"session-name"},mn={class:"name"},gn={class:"update-at"},fn=["innerHTML"];function hn(e,t,n,a,o,i){const c=(0,s.up)("loading"),l=(0,s.up)("scroll-box");return(0,s.wg)(),(0,s.iD)("div",an,[on,(0,s.Wm)(l,{listenHeight:"",topDisabled:"",bottomDisabled:e.disabledLoad,onTouchBottom:e.touchBottom,class:"session-list-container"},{default:(0,s.w5)((()=>[((0,s.wg)(!0),(0,s.iD)(s.HY,null,(0,s.Ko)(e.store.state.sessionListData.list,(t=>((0,s.wg)(),(0,s.iD)("div",{class:(0,k.C_)(["session-item",{"current-session":e.store.state.currentSession&&e.store.state.currentSession.sessionId==t.sessionId}]),key:t.sessionId,onClick:n=>e.changeSession(t)},[(0,s._)("div",ln,[(0,s._)("img",{src:t.cover,alt:""},null,8,rn),(0,s.wy)((0,s._)("div",{class:"unread-num",style:(0,k.j5)("font-weight:"+(t.read>99?"bold":"normal")),textContent:(0,k.zw)(t.read<=99?t.read:"···")},null,12,dn),[[g.F8,t.read]])]),(0,s._)("div",un,[(0,s._)("div",pn,[(0,s._)("span",mn,(0,k.zw)(t.sessionName),1),(0,s._)("span",gn,(0,k.zw)(e.timeHandler(t.updatedAt)),1)]),(0,s._)("div",{class:"last-chat",innerHTML:e.transToTag(t.lastChat,16)},null,8,fn)])],10,cn)))),128)),(0,s.wy)((0,s.Wm)(c,{class:"loading",scale:.7},null,8,["scale"]),[[g.F8,e.store.state.sessionListData.isMore]])])),_:1},8,["bottomDisabled","onTouchBottom"])])}var vn=n(678),wn=(0,s.aZ)({components:{ScrollBox:Le.Z,Loading:Q.Z},name:"session-list",setup(){const e=(0,m.oR)(),t=(0,vn.yj)(),n=(0,Y.qj)({disabledLoad:!1}),a={timeHandler:(0,s.Fl)((()=>function(e){return parseInt(e)>=o?Se()(parseInt(e)).format("HH:mm"):Se()(1*parseInt(e)).format("YY/M/DD")}))};let o=Se()().startOf("day").valueOf();if(t.params.friendId){let n=e.state.sessionListData.list.find((e=>e.receiverId.toString()===t.params.friendId));e.commit("setCurrentSession",n)}(0,s.bv)((()=>{e.state.currentSession&&(e.commit("setTotalUnread",e.state.totalUnread-e.state.currentSession.read),e.state.currentSession.read=0,e.state.socket.emit("request",{function:"resetUnread",params:{sessionId:e.state.currentSession.sessionId,userId:e.state.userInfo.id}}))}));const i=t=>{e.commit("setTotalUnread",e.state.totalUnread-t.read),t.read=0,e.state.socket.emit("request",{function:"resetUnread",params:{sessionId:t.sessionId,userId:e.state.userInfo.id}});let n=e.state.currentSession;n&&n.sessionId===t.sessionId||e.commit("setCurrentSession",t)},c=()=>{X().publish("loadSessionList")};return{store:e,...(0,Y.BK)(n),...a,touchBottom:c,changeSession:i,transToTag:O.tZ}}});const bn=(0,K.Z)(wn,[["render",hn],["__scopeId","data-v-5c07dbb6"]]);var kn=bn,yn=(0,s.aZ)({components:{ChatWindow:nn,SessionList:kn},name:"chat-page"});const _n=(0,K.Z)(yn,[["render",o],["__scopeId","data-v-560dd598"]]);var In=_n},5522:function(e,t,n){e.exports=n.p+"img/logo.7d1a3f32.svg"},9295:function(e,t,n){e.exports=n.p+"img/fileImg.e559eff4.png"}}]);
//# sourceMappingURL=853.6b13821a.js.map